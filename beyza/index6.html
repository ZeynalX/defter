<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beyza Haftalık Ders Programı</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Crimson+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        :root {
            /* Arka Plan */
            --bg-color: #f2f2f7;
            
            /* Cam Efekti */
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: 1px solid rgba(255, 255, 255, 0.4);
            --glass-blur: blur(20px);
            --shadow-soft: 0 10px 40px rgba(0, 0, 0, 0.08);

            /* Metin */
            --text-primary: #1c1c1e;
            --text-secondary: #8e8e93;
            --accent-color: #8d6e63;
            
            /* Nokta Renkleri */
            --dot-holiday: #ff3b30;
            --dot-special: #af52de;
            --dot-religious: #34c759;
            --dot-school: #007aff;

            /* Boyutlar - KÜÇÜLTÜLDÜ */
            --radius-xl: 20px;
            --radius-md: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Crimson Pro', serif;
            color: var(--text-primary);
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(at 100% 100%, hsla(280, 56%, 89%, 1) 0px, transparent 50%),
                radial-gradient(at 0% 0%, hsla(240, 52%, 92%, 1) 0px, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            padding-bottom: 80px; /* Alt boşluk azaltıldı */
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            box-shadow: var(--shadow-soft);
            border-radius: var(--radius-xl);
        }

        /* HEADER */
        header {
            position: sticky;
            top: 5px; /* Daha yukarı */
            z-index: 1000;
            margin: 5px 10px; /* Kenar boşlukları azaltıldı */
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .header-top { display: flex; align-items: center; justify-content: space-between; }
        
        .user-name {
            font-family: 'Cinzel Decorative', cursive;
            font-size: 1rem; /* Küçültüldü */
            font-weight: 700;
            color: var(--text-primary);
        }

        .week-navigation { display: flex; align-items: center; gap: 5px; }

        header h1 {
            font-family: 'Cinzel Decorative', cursive;
            font-size: 0.85rem; /* Küçültüldü */
            font-weight: 700;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 3px;
            padding: 5px 10px;
            background: rgba(255,255,255,0.5);
            border-radius: 50px;
            transition: 0.2s;
        }
        header h1::after { content: 'expand_more'; font-family: 'Material Icons'; font-size: 1em; opacity: 0.5; }

        .nav-button {
            background: rgba(255,255,255,0.5);
            border: none;
            border-radius: 50%;
            width: 28px; /* Butonlar küçüldü */
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-primary);
            transition: 0.2s;
        }
        .nav-button:hover { background: white; }
        .nav-button i { font-size: 18px; } /* İkon boyutu ayarlandı */

        header h2 { font-size: 0.75rem; color: var(--text-secondary); font-weight: 500; margin-left: 5px; }

        /* GÜN BAR - KOMPAKT */
        .day-nav {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            position: sticky;
            top: 75px; /* Header küçüldüğü için yukarı kaydı */
            z-index: 999;
            margin: 0 10px 10px 10px;
            gap: 5px;
        }
        .day-nav button {
            font-family: 'Crimson Pro', serif;
            padding: 6px 3px;
            cursor: pointer;
            border: none;
            border-radius: var(--radius-md);
            background: transparent;
            color: var(--text-primary);
            transition: all 0.3s ease;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        /* Tarih Sayısı */
        .day-nav button span:first-child { 
            font-weight: 700; 
            font-size: 0.9rem; /* 1.15'ten 0.9'a indi */
        }
        /* Gün Adı (Pzt vb.) */
        .day-nav button span:last-child { 
            font-size: 0.6rem; /* 0.75'ten 0.6'ya indi */
            color: var(--text-secondary); 
            margin-top: 1px; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .day-nav button.active {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            color: black;
        }
        .day-nav button.active span:last-child { color: black; }

        .main-container { padding: 0 10px; max-width: 1000px; margin: 0 auto; }

        /* KARTLAR - KOMPAKT VE ŞIK */
        .schedule-card {
            margin-bottom: 8px; /* Boşluk azaltıldı */
            background: rgba(255, 255, 255, 0.6);
            border-radius: var(--radius-md);
            border: 1px solid rgba(255,255,255,0.4);
            display: flex;
            flex-direction: column;
        }
        .schedule-card.no-body { flex-direction: row; align-items: center; }
        
        .card-header {
            padding: 8px 12px; /* Padding daraltıldı */
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.03);
        }
        .schedule-card.no-body .card-header { border-bottom: none; width: 100%; }

        .lesson-time {
            font-size: 0.7rem; /* Sayı küçültüldü */
            padding: 3px 6px;
            border-radius: 5px;
            background: rgba(141, 110, 99, 0.1);
            color: var(--accent-color);
            font-weight: 700;
            min-width: 20px;
            text-align: center;
        }
        .lesson-name {
            font-family: 'Cinzel Decorative', cursive;
            font-weight: 700;
            font-size: 0.75rem; /* İstenen oran: 1rem -> 0.75rem */
            color: var(--text-primary);
            line-height: 1.2;
        }
        .card-body {
            padding: 8px 12px; /* Padding daraltıldı */
            line-height: 1.4;
            color: var(--text-primary);
            font-size: 0.8rem; /* İçerik metni de küçüldü */
            background: rgba(255,255,255,0.2);
            border-radius: 0 0 var(--radius-md) var(--radius-md);
        }

        /* DROPDOWN */
        .week-dropdown-content {
            display: none;
            position: absolute;
            top: 105%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            min-width: 240px;
            max-height: 50vh;
            overflow-y: auto;
            border-radius: var(--radius-md);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            z-index: 1002;
            padding: 5px;
        }
        .week-dropdown-content.show { display: block; }
        .week-dropdown-content a {
            color: var(--text-primary);
            padding: 8px 12px; /* Daha kompakt */
            text-decoration: none;
            display: block;
            font-size: 0.8rem; /* Font küçüldü */
            border-radius: 6px;
            margin-bottom: 2px;
        }
        .week-dropdown-content a:hover { background: #f2f2f7; }
        .week-dropdown-content a.active { background: var(--text-primary); color: white; }

        /* ACTION BUTTONS */
        .action-buttons-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
        }
        .action-button {
            width: 48px; /* Butonlar biraz daha kibar */
            height: 48px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            color: #333;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: 0.2s;
        }
        .action-button:hover { transform: translateY(-4px); background: white; }

        /* TAKVİM MODALI - AYNI SADE YAPI */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: #ffffff; padding: 0; border-radius: 20px; box-shadow: 0 30px 60px rgba(0,0,0,0.3); width: 92%; max-width: 400px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header-section { padding: 15px 15px 10px 15px; background: #fff; z-index: 2; }
        .modal-header-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .modal-month-title { font-family: 'Cinzel Decorative', cursive; font-size: 1.1rem; color: var(--text-primary); font-weight: 700; }
        .modal-close-btn { background: #f2f2f7; border: none; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #8e8e93; }
        .calendar-grid-wrapper { padding: 0 10px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; }
        .calendar-day-header { font-size: 0.65rem; color: #8e8e93; font-weight: 600; padding-bottom: 8px; text-transform: uppercase; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border-radius: 50%; margin: 2px; transition: 0.2s; position: relative; }
        .day-number { font-size: 0.9rem; font-weight: 400; z-index: 2; }
        .event-dots-container { display: flex; gap: 2px; position: absolute; bottom: 4px; justify-content: center; }
        .event-dot { width: 4px; height: 4px; border-radius: 50%; }
        .dot-holiday { background-color: var(--dot-holiday); }
        .dot-special { background-color: var(--dot-special); }
        .dot-religious { background-color: var(--dot-religious); }
        .dot-school { background-color: var(--dot-school); }
        .calendar-day:hover { background-color: #f2f2f7; }
        .calendar-day.today { color: var(--accent-color); font-weight: 800; }
        .calendar-day.weekend-day .day-number { color: #8e8e93; }
        .calendar-day.other-month { opacity: 0; pointer-events: none; }
        .calendar-events-list { background-color: #f9f9f9; border-top: 1px solid #eee; flex-grow: 1; overflow-y: auto; padding: 15px; margin-top: 5px; }
        .event-list-item { display: flex; align-items: center; gap: 10px; padding: 6px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .event-list-item:last-child { border-bottom: none; }
        .event-list-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .event-list-text { font-size: 0.8rem; color: var(--text-primary); }
        .empty-events-msg { text-align: center; color: var(--text-secondary); font-style: italic; font-size: 0.8rem; padding: 10px; }

        /* Week View Styles Update */
        #week-view-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; align-items: start; }
        .week-view-day-title { font-family: 'Cinzel Decorative', cursive; text-align: center; font-size: 0.8rem; padding: 6px; margin-bottom: 6px; background: rgba(255,255,255,0.5); border-radius: var(--radius-md); color: var(--accent-color); font-weight: 700; border: 1px solid rgba(255,255,255,0.5); }
        @media (max-width: 768px) { #week-view-container { grid-template-columns: 1fr; } .week-view-day-column { margin-bottom: 15px; } }

        @media print { header, .day-nav, .action-buttons-container { display: none !important; } #print-container { display: block !important; } body { background: white; } }
        #print-container { display: none; }
    </style>
</head>
<body>

    <header class="glass-panel">
        <div class="header-top">
            <span class="user-name">3-A Beyza Öğrt</span>
            <div class="week-navigation">
                <button id="prev-week-btn" class="nav-button" onclick="showPreviousWeek()"><i class="material-icons">chevron_left</i></button>
                <h1 id="week-title-display" onclick="toggleWeekDropdown()">Yükleniyor...</h1>
                <button id="next-week-btn" class="nav-button" onclick="showNextWeek()"><i class="material-icons">chevron_right</i></button>
                <div id="week-dropdown-content" class="week-dropdown-content"></div>
            </div>
        </div>
        <h2 id="date-display"></h2>
    </header>

    <nav id="day-nav" class="day-nav glass-panel"></nav>
    
    <main id="day-view-container" class="main-container"></main>
    <main id="week-view-container" class="main-container" style="display: none;"></main>

    <div class="action-buttons-container">
        <button id="calendar-btn" class="action-button" onclick="openCalendarModal()" title="Çalışma Takvimi"><i class="material-icons">calendar_month</i></button>
        <button id="toggle-view-btn" class="action-button" onclick="toggleView()" title="Hafta Görünümü"><i class="material-icons">view_week</i></button>
        <button id="print-btn" class="action-button" onclick="printSchedule()" title="Haftalık Programı Yazdır"><i class="material-icons">print</i></button>
    </div>
    <div id="print-container"></div>

    <div id="calendar-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header-section">
                <div class="modal-header-nav">
                    <button class="nav-button" id="modal-prev-month"><i class="material-icons" style="font-size:18px">chevron_left</i></button>
                    <span id="modal-month-year" class="modal-month-title"></span>
                    <button class="nav-button" id="modal-next-month"><i class="material-icons" style="font-size:18px">chevron_right</i></button>
                    <button class="modal-close-btn" onclick="closeCalendarModal()"><i class="material-icons" style="font-size:18px">close</i></button>
                </div>
                
                <div id="calendar-grid-header" class="calendar-grid"></div>
                <div class="calendar-grid-wrapper">
                    <div id="calendar-grid-body" class="calendar-grid"></div>
                </div>
            </div>

            <div id="calendar-events-list" class="calendar-events-list"></div>
        </div>
    </div>

    <script>
        // --- DEĞİŞKENLER VE TEMEL FONKSİYONLAR ---
        let finalSchedule = {};
        let currentWeekIndex = 0;
        let currentDayId = 'pazartesi';
        let isWeekViewActive = false;
        let allWeeksData = [];
        const dayOrder = { pazartesi: "Pazartesi", sali: "Salı", carsamba: "Çarşamba", persembe: "Perşembe", cuma: "Cuma" };
        
        const TR_MONTH_NAMES = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
        const TR_DAY_NAMES_SHORT = ["Pzt", "Sal", "Çar", "Per", "Cum", "Cmt", "Paz"];
        const TR_DAY_ID_MAP = ['pazar', 'pazartesi', 'sali', 'carsamba', 'persembe', 'cuma', 'cumartesi'];

        // DOM Elementleri
        const dayNav = document.getElementById('day-nav');
        const dayViewContainer = document.getElementById('day-view-container');
        const weekViewContainer = document.getElementById('week-view-container');
        const weekTitleDisplay = document.getElementById('week-title-display');
        const dateDisplay = document.getElementById('date-display');
        const prevWeekBtn = document.getElementById('prev-week-btn');
        const nextWeekBtn = document.getElementById('next-week-btn');
        const weekDropdownContent = document.getElementById('week-dropdown-content');

        // Takvim Elementleri
        let modalCurrentDate = new Date(2025, 8, 1);
        const calendarModal = document.getElementById('calendar-modal');
        const modalMonthYear = document.getElementById('modal-month-year');
        const calendarGridHeader = document.getElementById('calendar-grid-header');
        const calendarGridBody = document.getElementById('calendar-grid-body');
        const calendarEventsList = document.getElementById('calendar-events-list');

        // --- DATA ---
        const academicCalendarRanges = [
            { start: "2025-11-10", end: "2025-11-14", type: "break", label: "I. Dönem Ara Tatil" },
            { start: "2026-01-19", end: "2026-01-30", type: "break", label: "Yarıyıl Tatili" },
            { start: "2026-03-16", end: "2026-03-20", type: "break", label: "II. Dönem Ara Tatil" },
            { start: "2026-03-26", end: "2026-03-29", type: "religious", label: "Ramazan Bayramı" },
            { start: "2026-05-26", end: "2026-05-30", type: "religious", label: "Kurban Bayramı" },
            { start: "2025-09-09", end: "2025-09-12", type: "special-day", label: "15 Temmuz Demokrasi ve Millî Birlik Günü Anma" },
            { start: "2025-09-15", end: "2025-09-19", type: "special-day", label: "İlköğretim Haftası" },
            { start: "2025-09-29", end: "2025-10-05", type: "special-day", label: "Disleksi Haftası" },
            { start: "2025-10-07", end: "2025-10-12", type: "special-day", label: "Ahilik Kültürü Haftası" },
            { start: "2025-10-28", end: "2025-11-03", type: "special-day", label: "Kızılay Haftası" },
            { start: "2025-11-01", end: "2025-11-08", type: "special-day", label: "Lösemili Çocuklar Haftası" },
            { start: "2025-11-03", end: "2025-11-09", type: "special-day", label: "Organ Bağışı ve Nakli Haftası" },
            { start: "2025-11-10", end: "2025-11-16", type: "special-day", label: "Atatürk Haftası" },
            { start: "2025-11-20", end: "2025-11-22", type: "special-day", label: "Ağız ve Diş Sağlığı Haftası" },
            { start: "2025-11-24", end: "2025-11-27", type: "special-day", label: "Ağız ve Diş Sağlığı Haftası" },
            { start: "2025-12-06", end: "2025-12-14", type: "special-day", label: "Mevlana Haftası" },
            { start: "2025-12-08", end: "2025-12-14", type: "special-day", label: "İnsan Hakları ve Demokrasi Haftası" },
            { start: "2025-12-12", end: "2025-12-18", type: "special-day", label: "Tutum, Yatırım ve Türk Malları Haftası" },
            { start: "2025-12-20", end: "2025-12-27", type: "special-day", label: "Mehmet Akif Ersoy'u Anma Haftası" },
            { start: "2026-01-05", end: "2026-01-11", type: "special-day", label: "Enerji Tasarrufu Haftası" },
            { start: "2026-02-23", end: "2026-03-01", type: "special-day", label: "Vergi Haftası" },
            { start: "2026-02-23", end: "2026-03-01", type: "special-day", label: "Yeşilay Haftası" },
            { start: "2026-03-02", end: "2026-03-08", type: "special-day", label: "Girişimcilik Haftası" },
            { start: "2026-03-08", end: "2026-03-14", type: "special-day", label: "Bilim ve Teknoloji Haftası" },
            { start: "2026-03-14", end: "2026-03-15", type: "special-day", label: "Tüketiciyi Koruma Haftası" },
            { start: "2026-03-16", end: "2026-03-17", type: "special-day", label: "Tüketiciyi Koruma Haftası" },
            { start: "2026-03-16", end: "2026-03-21", type: "special-day", label: "Türk Dünyası ve Toplulukları Haftası" },
            { start: "2026-03-21", end: "2026-03-26", type: "special-day", label: "Orman Haftası" },
            { start: "2026-03-22", end: "2026-03-24", type: "special-day", label: "Yaşlılar Haftası" },
            { start: "2026-03-30", end: "2026-04-05", type: "special-day", label: "Kütüphaneler Haftası" },
            { start: "2026-04-01", end: "2026-04-05", type: "special-day", label: "Kanser Haftası" },
            { start: "2026-04-07", end: "2026-04-13", type: "special-day", label: "Dünya Sağlık Günü/Dünya Sağlık Haftası" },
            { start: "2026-04-14", end: "2026-04-19", type: "special-day", label: "Turizm Haftası" },
            { start: "2026-05-04", end: "2026-05-10", type: "special-day", label: "Bilişim Haftası" },
            { start: "2026-05-04", end: "2026-05-10", type: "special-day", label: "İş Sağlığı ve Güvenliği Haftası" },
            { start: "2026-05-04", end: "2026-05-10", type: "special-day", label: "Trafik ve İlkyardım Haftası" },
            { start: "2026-05-09", end: "2026-05-16", type: "special-day", label: "Engelliler Haftası" },
            { start: "2026-05-11", end: "2026-05-16", type: "special-day", label: "Vakıflar Haftası" },
            { start: "2026-05-18", end: "2026-05-24", type: "special-day", label: "Müzeler Haftası" },
            { start: "2026-06-01", end: "2026-06-07", type: "special-day", label: "Hayat Boyu Öğrenme Haftası" },
            { start: "2026-06-08", end: "2026-06-14", type: "special-day", label: "Çevre Koruma Haftası" }
        ];

        const academicCalendarSingleDays = {
            "2025-09-08": { type: "school-day", label: "Ders Yılı Başlangıcı" },
            "2026-01-16": { type: "school-day", label: "I. Dönem Ders Yılı Bitişi" },
            "2026-02-02": { type: "school-day", label: "II. Dönem Ders Yılı Başlangıcı" },
            "2026-06-26": { type: "school-day", label: "II. Dönem Ders Yılı Bitişi" },
            "2025-10-29": { type: "official", label: "Cumhuriyet Bayramı" },
            "2026-04-23": { type: "official", label: "Ulusal Egemenlik ve Çocuk Bayramı" },
            "2026-05-19": { type: "official", label: "Atatürk'ü Anma ve Gençlik ve Spor Bayramı" },
            "2025-10-02": { type: "special-day", label: "Dünya Disleksi Günü" },
            "2025-10-04": { type: "special-day", label: "Hayvanları Koruma Günü" },
            "2025-10-13": { type: "special-day", label: "Dünya Afet Azaltma Günü" },
            "2025-10-24": { type: "special-day", label: "Birleşmiş Milletler Günü" },
            "2025-11-12": { type: "special-day", label: "Afet Eğitimi Hazırlık Günü" },
            "2025-11-14": { type: "special-day", label: "Dünya Diyabet Günü" },
            "2025-11-20": { type: "special-day", label: "Dünya Çocuk Hakları Günü" },
            "2025-11-20": { type: "special-day", label: "Dünya Felsefe Günü" },
            "2025-11-24": { type: "special-day", label: "Öğretmenler Günü" },
            "2025-11-24": { type: "special-day", label: "Ağız ve Diş Sağlığı Günü" },
            "2025-12-03": { type: "special-day", label: "Dünya Engelliler Günü" },
            "2025-12-04": { type: "special-day", label: "Dünya Madenciler Günü" },
            "2025-12-05": { type: "special-day", label: "Türk Kadınına Seçme ve Seçilme Hakkı" },
            "2025-12-25": { type: "special-day", label: "Gaziantep'in Kurtuluşu" },
            "2026-02-28": { type: "special-day", label: "Sivil Savunma Günü" },
            "2026-03-08": { type: "special-day", label: "Dünya Kadınlar Günü" },
            "2026-03-12": { type: "special-day", label: "İstiklâl Marşı'nın Kabulü" },
            "2026-03-18": { type: "special-day", label: "Şehitler Günü" },
            "2026-03-27": { type: "special-day", label: "Dünya Tiyatrolar Günü" },
            "2026-04-02": { type: "special-day", label: "Dünya Otizm Farkındalık Günü" },
            "2026-04-07": { type: "special-day", label: "Kişisel Verileri Koruma Günü" },
            "2026-04-26": { type: "special-day", label: "Dünya Fikri Mülkiyet Günü" },
            "2026-04-29": { type: "special-day", label: "Kut'ül Amâre Zaferi" },
            "2026-05-09": { type: "special-day", label: "Anneler Günü" },
            "2026-05-25": { type: "special-day", label: "Etik Günü" },
            "2026-05-29": { type: "special-day", label: "İstanbul'un Fethi" },
            "2026-06-21": { type: "special-day", label: "Babalar Günü" }
        };

        // --- JS MANTIĞI ---
        function toggleWeekDropdown() { weekDropdownContent.classList.toggle('show'); }
        window.onclick = function(event) { if (!event.target.matches('#week-title-display') && !event.target.closest('#week-title-display')) { if (weekDropdownContent.classList.contains('show')) { weekDropdownContent.classList.remove('show'); } } }

        async function initializeSchedule() {
            try {
                 const [timetableRes, curriculumRes, weeksRes] = await Promise.all([
                    fetch('ders-programi.json'),
                    fetch('kazanimlar.json'),
                    fetch('haftalar.json')
                ]);
                const timetable = await timetableRes.json();
                const curriculum = await curriculumRes.json();
                allWeeksData = await weeksRes.json();

                const lessonCounters = {};
                for (const subject in curriculum) { lessonCounters[subject] = 0; }
                allWeeksData.forEach((week, index) => {
                    const weekKey = `week${index + 1}`;
                    finalSchedule[weekKey] = { name: week.name, dates: week.dates, days: {} };
                    for (const day in timetable) {
                        finalSchedule[weekKey].days[day] = [];
                        timetable[day].forEach((lessonName, lessonIndex) => {
                            let objective = "Kazanım veya etkinlik belirtilmemiş.";
                            if (curriculum[lessonName] && lessonCounters[lessonName] < curriculum[lessonName].length) { objective = curriculum[lessonName][lessonCounters[lessonName]]; lessonCounters[lessonName]++; }
                            finalSchedule[weekKey].days[day].push({ time: `${lessonIndex + 1}. Ders`, name: lessonName, objective: objective });
                        });
                    }
                });

                populateWeekDropdown(allWeeksData); 
                if (window.innerWidth > window.innerHeight) { isWeekViewActive = true; }
                const target = findCurrentWeekAndDay(allWeeksData);
                currentDayId = target.dayId;
                displayWeek(target.weekIndex);

                document.getElementById('modal-prev-month').addEventListener('click', () => { modalCurrentDate.setMonth(modalCurrentDate.getMonth() - 1); renderDynamicCalendar(); });
                document.getElementById('modal-next-month').addEventListener('click', () => { modalCurrentDate.setMonth(modalCurrentDate.getMonth() + 1); renderDynamicCalendar(); });
                renderDynamicCalendar();

            } catch (error) { console.error(error); weekTitleDisplay.textContent = "Hata!"; dateDisplay.textContent = "Veriler yüklenemedi."; }
        }

        function populateWeekDropdown(weeksData) { weekDropdownContent.innerHTML = ''; weeksData.forEach((week, index) => { const link = document.createElement('a'); link.href = "javascript:void(0)"; link.textContent = week.name; link.onclick = () => { displayWeek(index); }; weekDropdownContent.appendChild(link); }); }

        function populateDayNav(weekDatesString) {
            dayNav.innerHTML = '';
            const dayNames = { pazartesi: "Pzt", sali: "Sal", carsamba: "Çar", persembe: "Per", cuma: "Cum" };
            let startDate = null;
            if (weekDatesString) {
                const parts = weekDatesString.split(' - ');
                const startStr = parts[0];
                const fullDateStr = parts[1];
                const year = fullDateStr.split(' ').pop();
                let startParts = startStr.split(' ');
                if (startParts.length === 2) startParts.push(year);
                startDate = parseTurkishDate(startParts.join(' '));
            }
            let dayIndex = 0;
            for(const dayId in dayOrder) {
                const button = document.createElement('button');
                let dateLabel = "";
                if (startDate) { const d = new Date(startDate); d.setDate(startDate.getDate() + dayIndex); dateLabel = d.getDate().toString().padStart(2, '0'); }
                button.innerHTML = `<span>${dateLabel}</span><span>${dayNames[dayId]}</span>`;
                button.dataset.day = dayId;
                button.onclick = () => displayDay(dayId);
                dayNav.appendChild(button);
                dayIndex++;
            }
        }

        function displayWeek(weekIndex) {
            currentWeekIndex = weekIndex;
            const weekKey = `week${weekIndex + 1}`;
            const weekData = finalSchedule[weekKey];
            if (!weekData) return;
            weekTitleDisplay.textContent = weekData.name;
            dateDisplay.textContent = weekData.dates;
            const dropdownLinks = weekDropdownContent.querySelectorAll('a');
            dropdownLinks.forEach((link, idx) => { if (idx === weekIndex) link.classList.add('active'); else link.classList.remove('active'); });
            prevWeekBtn.disabled = weekIndex === 0;
            nextWeekBtn.disabled = weekIndex === allWeeksData.length - 1;
            populateDayNav(weekData.dates);
            if (isWeekViewActive) { renderWeekView(); dayNav.style.display = 'none'; dayViewContainer.style.display = 'none'; weekViewContainer.style.display = 'grid'; document.getElementById('toggle-view-btn').querySelector('i').textContent = 'view_day'; } 
            else { displayDay(currentDayId); dayNav.style.display = 'flex'; dayViewContainer.style.display = 'block'; weekViewContainer.style.display = 'none'; document.getElementById('toggle-view-btn').querySelector('i').textContent = 'view_week'; }
        }

        function displayDay(dayId) {
            currentDayId = dayId; dayViewContainer.innerHTML = '';
            const weekKey = `week${currentWeekIndex + 1}`;
            const lessons = finalSchedule[weekKey]?.days[dayId] || [];
            lessons.forEach(lesson => {
                const card = document.createElement('div');
                const isObjectiveEmpty = lesson.objective.includes("belirtilmemiş");
                card.className = isObjectiveEmpty ? 'schedule-card no-body' : 'schedule-card';
                const lessonNum = lesson.time.replace('. Ders', '.');
                let htmlContent = `<div class="card-header"><span class="lesson-time">${lessonNum}</span><span class="lesson-name">${lesson.name}</span></div>`;
                if (!isObjectiveEmpty) { htmlContent += `<div class="card-body">${lesson.objective}</div>`; }
                card.innerHTML = htmlContent;
                dayViewContainer.appendChild(card);
            });
            document.querySelectorAll('.day-nav button').forEach(btn => btn.classList.toggle('active', btn.dataset.day === dayId));
        }

        function renderWeekView() {
            weekViewContainer.innerHTML = '';
            const weekKey = `week${currentWeekIndex + 1}`;
            const weekData = finalSchedule[weekKey];
            let startDate = null;
            if (weekData.dates) {
                 const parts = weekData.dates.split(' - ');
                 const startStr = parts[0];
                 const fullDateStr = parts[1];
                 const year = fullDateStr.split(' ').pop();
                 let startParts = startStr.split(' ');
                 if (startParts.length === 2) startParts.push(year);
                 startDate = parseTurkishDate(startParts.join(' '));
            }
            let dayIndex = 0;
            for (const dayId in dayOrder) {
                const column = document.createElement('div');
                column.className = 'week-view-day-column';
                let dayTitle = dayOrder[dayId];
                if (startDate) { const d = new Date(startDate); d.setDate(startDate.getDate() + dayIndex); dayTitle = `${d.getDate().toString().padStart(2, '0')} ${dayTitle}`; }
                let lessonsHTML = `<h3 class="week-view-day-title">${dayTitle}</h3>`;
                const lessons = weekData.days[dayId] || [];
                lessons.forEach(lesson => {
                    const isObjectiveEmpty = lesson.objective.includes("belirtilmemiş");
                    const cardClass = isObjectiveEmpty ? 'schedule-card no-body' : 'schedule-card';
                    const lessonNum = lesson.time.replace('. Ders', '.');
                    lessonsHTML += `<div class="${cardClass}"><div class="card-header"><span class="lesson-time">${lessonNum}</span><span class="lesson-name">${lesson.name}</span></div>`;
                    if (!isObjectiveEmpty) { lessonsHTML += `<div class="card-body">${lesson.objective}</div>`; }
                    lessonsHTML += `</div>`;
                });
                column.innerHTML = lessonsHTML;
                weekViewContainer.appendChild(column);
                dayIndex++;
            }
        }

        function showPreviousWeek() { if (currentWeekIndex > 0) displayWeek(currentWeekIndex - 1); }
        function showNextWeek() { if (currentWeekIndex < allWeeksData.length - 1) displayWeek(currentWeekIndex + 1); }
        function toggleView() { isWeekViewActive = !isWeekViewActive; displayWeek(currentWeekIndex); }
        function printSchedule() { const printContainer = document.getElementById('print-container'); const weekKey = `week${currentWeekIndex + 1}`; const week = finalSchedule[weekKey]; let pageHeaderHTML = `<div class="print-page-header"><h1>${week.name}</h1><p>${week.dates}</p></div>`; let daysHTML = '<div class="print-days-flex-container">'; for (const dayId in dayOrder) { daysHTML += `<div class="print-day-container"><h3 class="print-day-title">${dayOrder[dayId]}</h3>`; const lessons = week.days[dayId] || []; lessons.forEach(lesson => { const isObjectiveEmpty = lesson.objective.includes("belirtilmemiş"); const bodyClass = isObjectiveEmpty ? 'print-card-body empty' : 'print-card-body'; daysHTML += `<div class="print-card"><div class="print-card-header"><span class="print-lesson-name">${lesson.name}</span><span>${lesson.time}</span></div>`; if (!isObjectiveEmpty) { daysHTML += `<div class="${bodyClass}">${lesson.objective}</div>`; } daysHTML += `</div>`; }); daysHTML += `</div>`; } daysHTML += '</div>'; printContainer.innerHTML = pageHeaderHTML + daysHTML; window.print(); }

        function parseTurkishDate(dateString) { const m = { 'ocak': 0, 'şubat': 1, 'mart': 2, 'nisan': 3, 'mayıs': 4, 'haziran': 5, 'temmuz': 6, 'ağustos': 7, 'eylül': 8, 'ekim': 9, 'kasım': 10, 'aralık': 11 }; const p = dateString.toLowerCase().split(' '); if (p.length<2) return null; const d=parseInt(p[0],10), mo=m[p[1]], y=p.length>2?parseInt(p[2],10):new Date().getFullYear(); if(isNaN(d)||mo===undefined||isNaN(y))return null; return new Date(y,mo,d); };
        function findWeekIndexForDate(targetDate) { if (!targetDate) return -1; targetDate.setHours(0, 0, 0, 0); for(let i = 0; i < allWeeksData.length; i++) { const week = allWeeksData[i]; const parts = week.dates.split(' - '); const startStr = parts[0]; const fullDateStr = parts[1]; const year = fullDateStr.split(' ').pop(); let startParts = startStr.split(' '); if (startParts.length === 2) startParts.push(year); const startDate = parseTurkishDate(startParts.join(' ')); const endDate = parseTurkishDate(parts[1]); if (startDate && endDate) { startDate.setHours(0, 0, 0, 0); endDate.setHours(0, 0, 0, 0); if (targetDate >= startDate && targetDate <= endDate) { return i; } } } return -1; }
        function findCurrentWeekAndDay(weeksData) { const today = new Date(); today.setHours(0, 0, 0, 0); const dayOfWeek = today.getDay(); const targetDate = new Date(today); if (dayOfWeek === 6) { targetDate.setDate(targetDate.getDate() + 2); } else if (dayOfWeek === 0) { targetDate.setDate(targetDate.getDate() + 1); } let todayDayId = TR_DAY_ID_MAP[dayOfWeek]; if (dayOfWeek === 0 || dayOfWeek === 6) { todayDayId = 'pazartesi'; } const weekIndex = findWeekIndexForDate(targetDate); if (weekIndex !== -1) { return { weekIndex: weekIndex, dayId: todayDayId }; } return { weekIndex: 0, dayId: 'pazartesi' }; }

        function openCalendarModal() { const weekKey = `week${currentWeekIndex + 1}`; const weekDates = finalSchedule[weekKey]?.dates; if (weekDates) { const parts = weekDates.split(' - '); const startStr = parts[0]; const fullDateStr = parts[1]; const year = fullDateStr.split(' ').pop(); let startParts = startStr.split(' '); if (startParts.length === 2) startParts.push(year); const modalStartDate = parseTurkishDate(startParts.join(' ')); if (modalStartDate) { modalCurrentDate = modalStartDate; } } renderDynamicCalendar(); calendarModal.style.display = 'flex'; }
        function closeCalendarModal() { calendarModal.style.display = 'none'; }
        function getISODateString(date) { const year = date.getFullYear(); const month = (date.getMonth() + 1).toString().padStart(2, '0'); const day = date.getDate().toString().padStart(2, '0'); return `${year}-${month}-${day}`; }
        function getEventForDate(date) { const dateString = getISODateString(date); let events = []; if (academicCalendarSingleDays[dateString]) { events.push(academicCalendarSingleDays[dateString]); } academicCalendarRanges.forEach(range => { const startDate = new Date(range.start + 'T00:00:00'); const endDate = new Date(range.end + 'T00:00:00'); const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate()); if (dateOnly >= startDate && dateOnly <= endDate) { events.push({ type: range.type, label: range.label }); } }); if (events.length === 0) return null; const uniqueTypes = [...new Set(events.map(e => e.type))]; let uniqueEvents = uniqueTypes.map(type => { const eventsOfType = events.filter(e => e.type === type); const combinedLabel = eventsOfType.map(e => e.label).join(' / '); return { type: type, label: combinedLabel }; }); uniqueEvents.sort((a, b) => { const priority = { 'break': 1, 'religious': 2, 'official': 3, 'school-day': 4, 'special-day': 5 }; return (priority[a.type] || 99) - (priority[b.type] || 99); }); return uniqueEvents; }

        function navigateToDate(date) { 
            const weekIndex = findWeekIndexForDate(new Date(date.getTime())); 
            const dayOfWeek = date.getDay(); 
            const dayId = TR_DAY_ID_MAP[dayOfWeek]; 
            if (weekIndex !== -1 && dayId !== 'pazar' && dayId !== 'cumartesi') { 
                currentDayId = dayId; 
                currentWeekIndex = weekIndex; 
                if (isWeekViewActive) { toggleView(); } else { displayWeek(weekIndex); } 
                closeCalendarModal(); 
            }
        }

        // --- CALENDAR RENDER (Dots Only) ---
        function renderDynamicCalendar() {
            const year = modalCurrentDate.getFullYear();
            const month = modalCurrentDate.getMonth();
            modalMonthYear.textContent = `${TR_MONTH_NAMES[month]} ${year}`;
            
            calendarGridHeader.innerHTML = '';
            calendarGridBody.innerHTML = '';
            calendarEventsList.innerHTML = '<div class="empty-events-msg">Etkinlikleri görmek için bir güne tıklayın.</div>';

            TR_DAY_NAMES_SHORT.forEach(dayName => { calendarGridHeader.innerHTML += `<div class="calendar-day-header">${dayName}</div>`; });
            
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            let dayOfWeek = firstDayOfMonth.getDay();
            let startOffset = (dayOfWeek === 0) ? 6 : dayOfWeek - 1;
            const today = new Date(); today.setHours(0, 0, 0, 0);

            for (let i = 0; i < startOffset; i++) { calendarGridBody.innerHTML += `<div class="calendar-day other-month"></div>`; }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                let classes = 'calendar-day';
                const dayOfWeekForClick = date.getDay();
                if (date.getTime() === today.getTime()) classes += ' today';
                if (dayOfWeekForClick === 0 || dayOfWeekForClick === 6) classes += ' weekend-day';
                
                const events = getEventForDate(date);
                let dotsHTML = '';
                
                if (events && events.length > 0) {
                    dotsHTML = '<div class="event-dots-container">';
                    events.slice(0, 3).forEach(ev => {
                        let dotClass = '';
                        if (ev.type === 'break' || ev.type === 'official') dotClass = 'dot-holiday';
                        else if (ev.type === 'religious') dotClass = 'dot-religious';
                        else if (ev.type === 'school-day') dotClass = 'dot-school';
                        else dotClass = 'dot-special';
                        dotsHTML += `<div class="event-dot ${dotClass}"></div>`;
                    });
                    dotsHTML += '</div>';
                }

                const cell = document.createElement('div');
                cell.className = classes;
                cell.innerHTML = `<span class="day-number">${day}</span>${dotsHTML}`;
                cell.onclick = () => showEventsForDay(date, events);
                calendarGridBody.appendChild(cell);
            }
        }

        function showEventsForDay(date, events) {
            calendarEventsList.innerHTML = '';
            const dateHeader = document.createElement('div');
            dateHeader.style.cssText = 'font-weight:700; color:var(--text-primary); margin-bottom:10px; font-size:0.9rem; display:flex; justify-content:space-between; align-items:center;';
            const dayName = TR_DAY_NAMES_SHORT[date.getDay() === 0 ? 6 : date.getDay() - 1];
            dateHeader.innerHTML = `<span>${date.getDate()} ${TR_MONTH_NAMES[date.getMonth()]} ${dayName}</span>`;
            
            const weekIndex = findWeekIndexForDate(new Date(date.getTime()));
            const dayId = TR_DAY_ID_MAP[date.getDay()];
             if (weekIndex !== -1 && dayId !== 'pazar' && dayId !== 'cumartesi') {
                 const goBtn = document.createElement('button');
                 goBtn.textContent = "Programa Git";
                 goBtn.style.cssText = "background:var(--text-primary); color:white; border:none; padding:4px 10px; border-radius:12px; font-size:0.7rem; cursor:pointer;";
                 goBtn.onclick = () => navigateToDate(date);
                 dateHeader.appendChild(goBtn);
             }
            
            calendarEventsList.appendChild(dateHeader);

            if (!events || events.length === 0) {
                calendarEventsList.innerHTML += '<div class="empty-events-msg">Bugün için özel bir etkinlik yok.</div>';
                return;
            }

            events.forEach(ev => {
                let dotColor = 'var(--dot-special)';
                if (ev.type === 'break' || ev.type === 'official') dotColor = 'var(--dot-holiday)';
                else if (ev.type === 'religious') dotColor = 'var(--dot-religious)';
                else if (ev.type === 'school-day') dotColor = 'var(--dot-school)';

                const item = document.createElement('div');
                item.className = 'event-list-item';
                item.innerHTML = `
                    <div class="event-list-dot" style="background-color: ${dotColor}"></div>
                    <div class="event-list-text">${ev.label}</div>
                `;
                calendarEventsList.appendChild(item);
            });
        }

        document.addEventListener('DOMContentLoaded', initializeSchedule);
        window.addEventListener('resize', () => { if (isWeekViewActive !== (window.innerWidth > window.innerHeight)) toggleView(); });
    </script>
</body>
</html>
